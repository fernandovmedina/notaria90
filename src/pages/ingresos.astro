---
import Layout from "../layouts/Layout.astro";
import InsideHeader from "../components/InsideHeader.astro";
---

<Layout>
  <InsideHeader />
  <div class="max-w-4xl mx-auto p-6 border rounded-lg shadow mt-10 bg-white">
    <h2 class="text-2xl font-bold text-center mb-6">Pagos realizados</h2>

    <div class="flex flex-col gap-4 mb-6">
      <input
        type="text"
        placeholder="Nombre completo"
        class="border rounded px-4 py-2 w-full"
      />

      <input
        type="number"
        placeholder="Numero de tarjeta"
        class="border rounded px-4 py-2 w-full"
      />

      <div class="flex flex-col md:flex-row gap-4">
        <input
          type="text"
          placeholder="Fecha de vencimiento"
          class="border rounded px-4 py-2 w-full md:w-1/3"
        />
        <input
          type="text"
          placeholder="CVV"
          class="border rounded px-4 py-2 w-full md:w-1/3"
        />
        <input
          type="text"
          placeholder="Monto"
          class="border rounded px-4 py-2 w-full md:w-1/3"
        />
      </div>

      <button
        class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600 transition w-fit self-center"
        id="btn-pagar"
      >
        Realizar pago
      </button>
    </div>

    <script is:client type="module">
      // Obtener parámetros de la URL
      const params = new URLSearchParams(window.location.search);
      const montoUrl = params.get("monto");
      const idEscritura = params.get("id_escritura_publica");
      const idCartaPoder = params.get("id_carta_poder");

      // Si hay monto en la URL, asignarlo al input correspondiente
      if (montoUrl) {
        const inputs = document.querySelectorAll("input");
        const montoInput = Array.from(inputs).find((input) =>
          input.placeholder.toLowerCase().includes("monto"),
        );
        if (montoInput) {
          montoInput.value = montoUrl;
        }
      }

      // Agregar evento al botón
      document
        .getElementById("btn-pagar")
        .addEventListener("click", async () => {
          const inputs = document.querySelectorAll("input");
          const [nombre, tarjeta, vencimiento, cvv, monto] = Array.from(
            inputs,
          ).map((i) => i.value.trim());

          const body = {
            nombre,
            tarjeta,
            fecha_de_vencimiento: vencimiento,
            cvv: parseInt(cvv),
            monto,
          };

          if (idEscritura) body.id_escritura_publica = parseInt(idEscritura);
          if (idCartaPoder) body.id_carta_poder = parseInt(idCartaPoder);

          const res = await fetch("http://localhost:8080/api/user/pago", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          if (res.ok) {
            alert("Pago registrado exitosamente.");
            window.location.href = "/expedientes";
          } else {
            alert("Error al registrar el pago.");
          }
        });
    </script>
  </div>
</Layout>
