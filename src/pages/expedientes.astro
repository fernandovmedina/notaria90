---
import InsideHeader from "../components/InsideHeader.astro";
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <InsideHeader />
  <div class="max-w-6xl mx-auto p-8 bg-white border rounded shadow mt-10">
    <h2 class="text-2xl font-bold text-center mb-6">Mis tramites</h2>

    <div class="overflow-x-auto">
      <table
        class="min-w-full bg-white border rounded shadow"
        id="tramites-table"
      >
        <thead class="bg-gray-100 text-gray-700 text-sm">
          <tr>
            <th class="py-3 px-4 text-left border">ID</th>
            <th class="py-3 px-4 text-left border">Tipo</th>
            <th class="py-3 px-4 text-left border">Datos principales</th>
            <th class="py-3 px-4 text-left border">Detalles</th>
            <th class="py-3 px-4 text-center border">Acciones</th>
          </tr>
        </thead>
        <tbody id="tramites-body">
          <tr>
            <td colspan="5" class="text-center py-4">Cargando trámites...</td>
          </tr>
        </tbody>
      </table>

      <div class="flex justify-center mt-6">
        <a
          href="/personalizados"
          class="text-blue-600 font-medium hover:underline"
        >
          Nuevo trámite
        </a>
      </div>
    </div>
  </div>

  <script type="module" is:client>
    const tbody = document.getElementById("tramites-body");
    tbody.innerHTML = "";

    fetch("http://168.231.75.191:8080/api/user/tramites", {
      credentials: "include",
    })
      .then((res) => res.json())
      .then((data) => {
        const { cartas_poder = [], escrituras_publicas = [] } = data.body || {};
        const rows = [];

        for (const c of cartas_poder) {
          const estaPagado = c.id_pago !== null && c.id_pago !== undefined;

          rows.push(`
    <tr class="hover:bg-gray-50">
      <td class="py-2 px-4 border">${c.id_carta_poder}</td>
      <td class="py-2 px-4 border font-semibold text-blue-600">Carta poder</td>
      <td class="py-2 px-4 border">
        <strong>Poderante:</strong> ${c.poderante}<br>
        <strong>Apoderado:</strong> ${c.apoderado}
      </td>
      <td class="py-2 px-4 border">
        <strong>Domicilio:</strong> ${c.domicilio}<br>
        <strong>Teléfono:</strong> ${c.telefono}<br>
        <strong>RFC:</strong> ${c.rfc}
      </td>
      <td class="py-2 px-4 border text-center">
        <a href="/carta?poderante=${c.poderante}&apoderado=${c.apoderado}&domicilio=${c.domicilio}&telefono=${c.telefono}&rfc=${c.rfc}" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600 mr-2">Ver</a>
        ${
          estaPagado
            ? `<span class="bg-green-500 text-white px-4 py-1 rounded">Pagado</span>`
            : `<a href="/ingresos?id_carta_poder=${c.id_carta_poder}&monto=899.99" class="bg-red-500 text-white px-4 py-1 rounded hover:bg-red-600">Pagar</a>`
        }
      </td>
    </tr>
  `);
        }

        for (const e of escrituras_publicas) {
          const estaPagado = e.id_pago !== null && e.id_pago !== undefined;

          rows.push(`
    <tr class="hover:bg-gray-50">
      <td class="py-2 px-4 border">${e.id_escritura_publica}</td>
      <td class="py-2 px-4 border font-semibold text-green-600">Escritura pública</td>
      <td class="py-2 px-4 border">
        <strong>Nombre:</strong> ${e.nombre}<br>
        <strong>Nacionalidad:</strong> ${e.nacionalidad}
      </td>
      <td class="py-2 px-4 border">
        <strong>Estado civil:</strong> ${e.estado_civil}<br>
        <strong>Ocupación:</strong> ${e.ocupacion}<br>
        <strong>CURP:</strong> ${e.curp}
      </td>
      <td class="py-2 px-4 border text-center">
        <a href="/escritura?nombre=${e.nombre}&nacionalidad=${e.nacionalidad}&estado_civil=${e.estado_civil}&ocupacion=${e.ocupacion}&curp=${e.curp}" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600 mr-2">Ver</a>
        ${
          estaPagado
            ? `<span class="bg-green-500 text-white px-4 py-1 rounded">Pagado</span>`
            : `<a href="/ingresos?id_escritura_publica=${e.id_escritura_publica}&monto=999.99" class="bg-red-500 text-white px-4 py-1 rounded hover:bg-red-600">Pagar</a>`
        }
      </td>
    </tr>
  `);
        }

        if (rows.length > 0) {
          tbody.innerHTML = rows.join("");
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center py-4 text-gray-500">No tienes trámites registrados.</td>
            </tr>
          `;
        }
      })
      .catch((err) => {
        console.error("Error al obtener trámites:", err);
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center py-4 text-red-500">Error al cargar los trámites.</td>
          </tr>
        `;
      });
  </script>
</Layout>
