---
import Layout from "../layouts/Layout.astro";
import InsideHeader from "../components/InsideHeader.astro";
---

<Layout>
  <html>
    <head>
      <title>Solicitar Cita</title>
    </head>
    <body class="flex flex-col items-center justify-start min-h-screen bg-gray-100">
      <InsideHeader />
      <div class="bg-white p-8 rounded-2xl shadow-lg mt-8 w-full">
        <h2 class="text-2xl font-semibold text-center mb-4">Solicitar Cita</h2>
        <form id="appointment-form">
          <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Nombre</label>
            <input
              name="nombre"
              type="text"
              class="w-full py-2 px-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
              placeholder="Ingrese su nombre"
              required
            />
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Apellido</label>
            <input
              name="apellidos"
              type="text"
              class="w-full py-2 px-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
              placeholder="Ingrese su apellido"
              required
            />
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Día</label>
            <input
              name="dia"
              type="text"
              placeholder="mm/dd/yyyy hh:mm"
              class="w-full py-2 px-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
              required
            />
          </div>
          <button
            class="w-full bg-blue-500 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-600 transition"
          >
            Solicitar
          </button>
        </form>
      </div>

      <div class="bg-white p-8 rounded-2xl shadow-lg mt-8 w-screen px-8">
        <h2 class="text-2xl font-semibold text-center mb-4">Citas Pendientes</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto border border-gray-300">
            <thead>
              <tr class="bg-gray-200 text-left">
                <th class="px-4 py-2 border-b">Nombre</th>
                <th class="px-4 py-2 border-b">Apellido</th>
                <th class="px-4 py-2 border-b">Fecha y hora</th>
              </tr>
            </thead>
            <tbody id="citas-body">
              <tr>
                <td colspan="3" class="px-4 py-2 text-center text-gray-500">Cargando citas...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <script>
        const form = document.getElementById("appointment-form");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(form);
          const data = new URLSearchParams(formData);

          const res = await fetch("http://localhost:8080/api/user/register-appointment", {
            method: "POST",
            body: data,
            mode: "cors",
            credentials: "include",
          });

          if (res.ok) {
            alert("Cita registrada correctamente");
            form.reset();
            cargarCitas(); // Recargar la tabla
          } else {
            alert("Error al registrar la cita");
          }
        });

        async function cargarCitas() {
          try {
            const res = await fetch("http://localhost:8080/api/user/appointments", {
              method: "GET",
              credentials: "include",
            });

            const json = await res.json();
            const citas = json.body || [];

            const tbody = document.getElementById("citas-body");
            tbody.innerHTML = "";

            if (citas.length === 0) {
              tbody.innerHTML = `
                <tr>
                  <td colspan="3" class="px-4 py-2 text-center text-gray-500">No hay citas registradas.</td>
                </tr>
              `;
              return;
            }

            citas.forEach((cita) => {
              const row = document.createElement("tr");
              row.className = "hover:bg-gray-100";
              row.innerHTML = `
                <td class="px-4 py-2 border-b">${cita.nombre}</td>
                <td class="px-4 py-2 border-b">${cita.apellido}</td>
                <td class="px-4 py-2 border-b">${cita.dia}</td>
              `;
              tbody.appendChild(row);
            });
          } catch (err) {
            console.error("Error al cargar citas:", err);
            const tbody = document.getElementById("citas-body");
            tbody.innerHTML = `
              <tr>
                <td colspan="3" class="px-4 py-2 text-center text-red-500">Error al cargar citas.</td>
              </tr>
            `;
          }
        }

        // Cargar las citas al iniciar la página
        window.addEventListener("DOMContentLoaded", cargarCitas);
      </script>
    </body>
  </html>
</Layout>
